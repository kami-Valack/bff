name: build-and-deploy-aca

on:
  push:
    branches:
      - staging
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
         client-id: "e94f2756-2b23-4d3b-9796-3c3bd783aa07"
         tenant-id: "cca1305c-6b52-4fa3-ada6-314052d491d8"
         subscription-id: "67d40114-c56b-4f83-afc1-00b1e780c991"
         auth-type: SERVICE_PRINCIPAL

      - name: Login no Azure Container Registry
        run: az acr login --name acrdevc760b03e

      - name: Build da imagem Docker
        run: |
          docker build -t acrdevc760b03e.azurecr.io/bff:${{ github.sha }} .

      - name: Push da imagem para o ACR
        run: |
          docker push acrdevc760b03e.azurecr.io/bff:${{ github.sha }}

      - name: Criar ou atualizar Container App
        run: |
          az containerapp up \
            --name bff-app \
            --resource-group rg-app-dev \
            --environment aca-env-dev \
            --image acrdevc760b03e.azurecr.io/bff:${{ github.sha }} \
            --target-port 3333 \
            --ingress external \
            --registry-server acrdevc760b03e.azurecr.io \
            --registry-username $(az acr credential show --name acrdevc760b03e --query username -o tsv) \
            --registry-password $(az acr credential show --name acrdevc760b03e --query passwords[0].value -o tsv) \
            --env-vars SWAGGER_DOCS_USERNAME=backendteam \
                       SWAGGER_DOCS_PASSWORD=miraman \
                       CORS_ALLOWED_ORIGINS=""

      - name: Logout do Docker
        run: docker logout acrdevc760b03e.azurecr.io
