name: build-and-push

on:
  push:
    branches:
      - staging
      - main

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: "e94f2756-2b23-4d3b-9796-3c3bd783aa07"
          tenant-id: "cca1305c-6b52-4fa3-ada6-314052d491d8"
          subscription-id: "67d40114-c56b-4f83-afc1-00b1e780c991"
          environment: azurecloud
          auth-type: SERVICE_PRINCIPAL

      - name: Login no Azure Container Registry
        run: az acr login --name acrdevc760b03e

      - name: Build da imagem Docker
        run: |
          docker build -t acrdevc760b03e.azurecr.io/bff:${{ github.sha }} .

      - name: Push da imagem para o ACR
        run: |
          docker push acrdevc760b03e.azurecr.io/bff:${{ github.sha }}

      - name: Criar ou atualizar Azure Container App
        run: |
          set -e
          APP_NAME="bff-app"
          RG_NAME="rg-app-dev"
          ENV_NAME="aca-env-dev"
          IMAGE="acrdevc760b03e.azurecr.io/bff:${{ github.sha }}"
          ACR_SERVER="acrdevc760b03e.azurecr.io"

          # Vari√°veis de ambiente do container
          ENV_VARS="SWAGGER_DOCS_USERNAME=backendteam SWAGGER_DOCS_PASSWORD=miraman CORS_ALLOWED_ORIGINS="

          if az containerapp show --name $APP_NAME --resource-group $RG_NAME >/dev/null 2>&1; then
            echo "üîÑ Atualizando aplica√ß√£o existente..."
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG_NAME \
              --image $IMAGE \
              --env-vars $ENV_VARS
          else
            echo "üöÄ Criando nova aplica√ß√£o..."
            az containerapp create \
              --name $APP_NAME \
              --resource-group $RG_NAME \
              --environment $ENV_NAME \
              --image $IMAGE \
              --target-port 3333 \
              --ingress external \
              --registry-server $ACR_SERVER \
              --env-vars $ENV_VARS
          fi

      - name: Mostrar URL do Container App
        run: |
          URL=$(az containerapp show --name bff-app --resource-group rg-app-dev --query properties.configuration.ingress.fqdn -o tsv)
          echo "üåç URL da aplica√ß√£o: https://$URL"
